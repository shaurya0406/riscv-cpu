<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: RISC-V-main/rtl/as_rv32i_forwarding.v Source File</title>
<link href="tabs.vss" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.vss" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.vss" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.vss" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('as__rv32i__forwarding_8v_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">as_rv32i_forwarding.v</div></div>
</div><!--header-->
<div class="contents">
<a href="as__rv32i__forwarding_8v.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span>//////////////////////////////////////////////////////////////////////////////////</div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span>// Company: UQAC</div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span>// Engineer: SHACHA</div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span>// </div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span>// Create Date: 09/07/2023 02:47:12 PM</div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span>// Design Name: </div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span>// Module Name: as_rv32i_writeback</div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span>// Project Name: </div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span>// Target Devices: </div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span>// Tool Versions: </div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span>// Description: Pipeline Data Hazard Control [Forwarding &amp; Stalling]</div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span>/* </div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span>   By implementing operand forwarding, the rv32i_forwarding module is in charge of handling data dangers in the pipelined processor. Data dangers occur when earlier instructions that are still in the pipeline but have not yet written to the base register are about to overwrite a register value. </div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span>   This problem is solved by either halting the pipeline until the base register is changed (which is less efficient) or passing the updated operand value immediately from the pipeline stage where it is presently being computed.</div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span>   The following are key features of the rv32i_forwarding module:</div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span> - Transporting rs1 and rs2 operands: The module first sets the output values o_rs1 and o_rs2 to their base register values (i_rs1_orig and i_rs2_orig). It then checks for data hazards by comparing the operand register addresses (i_decoder_rs1_addr_q and i_decoder_rs2_addr_q) to the pipeline stages&#39; destination register addresses (i_alu_rd_addr and i_memoryaccess_rd_addr).</div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span> - rs1 operand forwarding: If the next value of rs1 is in stage 4 (Memory Access), and the Memory Access stage is enabled, and the next value of rs1 comes from a load or CSR instruction (i.e., rd is not valid at stage 4), the module stalls the ALU stage by asserting o_alu_force_stall. Otherwise, the module sends the rd value from stage 4 (i_alu_rd) to o_rs1. If the next value of rs1 is in stage 5 (Writeback), and the Writeback stage is enabled, the module forwards the value of rd from stage 5 to o_rs1.</div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span> - rs2 operand forwarding: If the next value of rs2 is in stage 4 (Memory Access), and the Memory Access stage is enabled, and the next value of rs2 is from a load or CSR instruction (i.e., rd is not yet valid at stage 4), the module stalls the ALU stage by asserting o_alu_force_stall. Otherwise, the module transfers the rd value from stage 4 (i_alu_rd) to o_rs2. If the next value of rs2 is in stage 5 (Writeback), and the Writeback stage is enabled, the module forwards the value of rd from stage 5 to o_rs2.</div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span> - Handling zero register (x0) forwarding: Because this register is hardwired to zero, the module ensures that no operation forwarding is executed when the register address is zero. The associated output register (o_rs1 or o_rs2) is set to zero if either i_decoder_rs1_addr_q or i_decoder_rs2_addr_q is zero. The rv32i_forwarding module mitigates data dangers by implementing operand forwarding, ensuring accurate instruction execution, and enhancing the overall efficiency of the RV32I pipelined processor.</div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span> </div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span>*/</div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span>// Dependencies: </div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span>// </div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span>// Revision:</div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span>// Revision 0.01 - File Created</div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span>// Additional Comments:</div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span>// </div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span>////////////////////////////////////////////////////////////////////////////////// </div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span> </div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span>`timescale 1ns / 1ps</div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span>`default_nettype none</div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span>`include &quot;as_rv32i_header.vh&quot;</div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span> </div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span>module rv32i_forwarding (</div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span>    input wire[31:0] i_rs1_orig, //current rs1 value saved in basereg</div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span>    input wire[31:0] i_rs2_orig, //current rs2 value saved in basereg</div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span>    input wire[4:0] i_decoder_rs1_addr_q, //address of operand rs1 used in ALU stage</div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span>    input wire[4:0] i_decoder_rs2_addr_q, //address of operand rs2 used in ALU stage</div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span>    output reg o_alu_force_stall, //high to force ALU stage to stall</div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span>    output reg[31:0] o_rs1, //rs1 value with Operand Forwarding</div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span>    output reg[31:0] o_rs2, //rs2 value with Operand Forwarding</div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span> </div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span>    /// Stage 4 [MEMORYACCESS] ///</div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span>    input wire[4:0] i_alu_rd_addr, //destination register address</div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span>    input wire i_alu_wr_rd, //high if rd_addr will be written</div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span>    input wire i_alu_rd_valid, //high if rd is already valid at this stage (not LOAD nor CSR instruction)</div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span>    input wire[31:0] i_alu_rd, //rd value in stage 4</div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span>    input wire i_memoryaccess_ce, //high if stage 4 is enabled</div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span> </div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span>    /// Stage 5 [WRITEBACK] ///</div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span>    input wire[4:0] i_memoryaccess_rd_addr, //destination register address</div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span>    input wire i_memoryaccess_wr_rd, //high if rd_addr will be written</div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span>    input wire[31:0] i_writeback_rd, //rd value in stage 5</div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span>    input wire i_writeback_ce //high if stage 4 is enabled</div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span>);</div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span> </div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span>    always @* begin</div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span>        o_rs1 = i_rs1_orig; //original value from basereg</div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span>        o_rs2 = i_rs2_orig; //original value from basereg</div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span>        o_alu_force_stall = 0;</div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span>         </div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span>        // Data Hazard = Register value is about to be overwritten by previous instructions but are still on the pipeline and are not yet written to basereg.</div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span>        // The solution to make sure the updated value of rs1 or rs2 is used is to either stall the pipeline until the basereg is updated (very inefficient) or use Operand Forwarding</div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span> </div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span>            // Operand Forwarding for rs1</div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span>            if((i_decoder_rs1_addr_q == i_alu_rd_addr) &amp;&amp; i_alu_wr_rd &amp;&amp; i_memoryaccess_ce) begin //next value of rs1 is currently on stage 4</div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span>                if(!i_alu_rd_valid) begin   //if next value of rs1 comes from load or CSR instruction then we must stall from ALU stage and wait until </div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span>                    o_alu_force_stall = 1;   //stage 4(Memoryaccess) becomes disabled, which means next value of rs1 is already at stage 5   </div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span>                end</div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span>                o_rs1 = i_alu_rd;</div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span>            end</div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span>            else if((i_decoder_rs1_addr_q == i_memoryaccess_rd_addr) &amp;&amp; i_memoryaccess_wr_rd &amp;&amp; i_writeback_ce) begin //next value of rs1 is currently on stage 5</div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span>                o_rs1 = i_writeback_rd;</div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span>            end</div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span>            </div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span>            // Operand Forwarding for rs2</div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span>            if((i_decoder_rs2_addr_q == i_alu_rd_addr) &amp;&amp; i_alu_wr_rd &amp;&amp; i_memoryaccess_ce) begin //next value of rs2 is currently on stage 4</div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno">   78</span>                if(!i_alu_rd_valid) begin   //if next value of rs2 comes from load or CSR instruction(rd is only available at stage 5) then we must stall from ALU stage and wait until </div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span>                    o_alu_force_stall = 1;   //stage 4(Memoryaccess) becomes disabled (which implicitly means that next value of rs2 is already at stage 5)   </div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span>                end</div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span>                o_rs2 = i_alu_rd;</div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span>            end</div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span>            else if((i_decoder_rs2_addr_q == i_memoryaccess_rd_addr) &amp;&amp; i_memoryaccess_wr_rd &amp;&amp; i_writeback_ce) begin //next value of rs2 is currently on stage 5</div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span>                o_rs2 = i_writeback_rd;</div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span>            end</div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span> </div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span>            // No operation forwarding necessary when addr is zero since that address is hardwired to zero</div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span>            if(i_decoder_rs1_addr_q == 0) o_rs1 = 0;</div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span>            if(i_decoder_rs2_addr_q == 0) o_rs2 = 0;</div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span>    end</div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span> </div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span>endmodule</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_35191fc563656ec8e3f935b60461952d.html">RISC-V-main</a></li><li class="navelem"><a class="el" href="dir_2820ad9171bf05546b333ebb8bc9bb96.html">rtl</a></li><li class="navelem"><a class="el" href="as__rv32i__forwarding_8v.html">as_rv32i_forwarding.v</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.7 </li>
  </ul>
</div>
</body>
</html>
