<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.7"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: RISC-V-main/rtl/as_rv32i_fetch.v Source File</title>
<link href="tabs.vss" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.vss" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.vss" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.vss" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.7 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('as__rv32i__fetch_8v_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">as_rv32i_fetch.v</div></div>
</div><!--header-->
<div class="contents">
<a href="as__rv32i__fetch_8v.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span>//////////////////////////////////////////////////////////////////////////////////</div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span>// Company: UQAC</div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span>// Engineer: SHACHA</div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span>// </div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span>// Create Date: 07/07/2023 02:55:30 PM</div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span>// Design Name: </div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span>// Module Name: as_rv32i_fetch</div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span>// Project Name: </div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span>// Target Devices: </div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span>// Tool Versions: </div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span>// Description: Pipeline Stage 1 retrieves instruction from the memory [FETCH STAGE]</div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span>/*</div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span>    The as_rv32i_fetch module is largely responsible for retrieving instructions from memory and preparing them for the pipeline&#39;s decode stage. The module is in charge of directing the pipeline, managing the Programme Counter (PC), and fetching instructions. The following are the main functions of the as_rv32i_fetch module:</div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span> - Programme Counter (PC) administration: The module keeps track of a Programme Counter (PC), which stores the address of the current instruction in memory. The PC is initialised at the reset vector address (given by the PC_RESET parameter), and it is incremented or updated dependent on instruction flow control, such as branches, jumps, or traps.</div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span> - Instruction fetching: Based on the current PC value, the module retrieves the instruction from memory. When the fetch stage (ce) is activated, it sends a request for a new instruction (o_stb_inst) and waits for an acknowledgment (i_ack_inst) from memory. The retrieved instruction (i_inst) is then routed to the pipeline (o_inst).</div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span> - Pipeline management: The as_rv32i_fetch module manages the pipeline by managing the following stage&#39;s clock enable (o_ce) signals. When the next stages are stalled (i_stall), a requested instruction has not yet been acknowledged, or there is no request for a new instruction, it can stall the fetch stage (stall_fetch). Furthermore, when the PC has to be changed, it can generate pipeline bubbles by disabling clock enable signals for the next stages, ensuring no instructions are executed during this time.</div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span> - PC control: The module updates the PC based on control signals received from previous stages of the pipeline. When handling traps, it can update the PC with a new address (i_writeback_next_pc) or the address of a taken branch or jump (i_alu_next_pc). During this process, the fetch stage might be halted to prevent instructions from being executed in the pipeline.</div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span> - Dealing with stalls and flushes: The as_rv32i_fetch module can halt the fetch stage under various scenarios and save the current PC and instruction values. When the stall situation has been overcome, it can return to the previously saved values and continue fetching instructions. When necessary, the module can flush the fetch stage (i_flush), deactivating the clock enable signal for the next stage and thus clearing any outstanding instructions.</div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span>*/ </div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span>// Dependencies: </div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span>// </div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span>// Revision:</div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span>// Revision 0.01 - File Created</div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span>// Additional Comments:</div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span>// </div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span>//////////////////////////////////////////////////////////////////////////////////</div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span> </div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span> </div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span>`timescale 1ns / 1ps</div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span>`default_nettype none</div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span>`include &quot;as_rv32i_header.vh&quot;</div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span> </div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span>module as_rv32i_fetch #(parameter PC_RESET = 32&#39;h00_00_00_00) (</div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span>    input wire i_clk,i_rst_n,</div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span>    output reg[31:0] o_iaddr,   // instruction memory address</div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span>    output reg[31:0] o_pc,      // PC value of current instruction </div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span>    input wire[31:0] i_inst,    // retrieved instruction from Memory</div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span>    output reg[31:0] o_inst,    // instruction sent to pipeline</div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span>    output wire o_stb_inst,     // request for instruction</div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span>    input wire i_ack_inst,      // ack (high when bus contains new instruction)</div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span> </div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span>    /// PC Control ///</div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span>    input wire i_writeback_change_pc,       // high when PC needs to change when going to trap or returning from trap</div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span>    input wire[31:0] i_writeback_next_pc,   // next PC due to trap</div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span>    input wire i_alu_change_pc,             // high when PC needs to change for taken branches and jumps</div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span>    input wire[31:0] i_alu_next_pc,         // next PC due to branch or jump</div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span> </div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span>    /// Pipeline Control ///</div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span>    output reg o_ce,    // output clk enable for pipeline stalling of next stage</div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span>    input wire i_stall, // stall logic for whole pipeline</div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span>    input wire i_flush  // flush this stage</div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span>);</div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span> </div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span>    reg[31:0] iaddr_d, prev_pc, stalled_inst, stalled_pc;</div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span>    reg ce, ce_d;</div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span>    reg stall_fetch;</div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span>    reg stall_q;</div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span> </div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span>    /* Stall this 1st stage when:</div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span>        - Next stages are stalled</div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span>        - New Instruction request without ack</div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span>        - No request</div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span>    */</div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span>    wire stall_bit = stall_fetch || i_stall || (o_stb_inst &amp;&amp; !i_ack_inst) || !o_stb_inst; </div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span>    assign o_stb_inst = ce; // request for new instruction if this stage is enabled                                                               </div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span>    </div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span>    //clock enable (ce) logic for 1st fetch stage</div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span>    always @(posedge i_clk, negedge i_rst_n) begin</div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span>         if(!i_rst_n) ce &lt;= 0;</div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span>         else if((i_alu_change_pc || i_writeback_change_pc) &amp;&amp; !(i_stall || stall_fetch)) ce &lt;= 0; // When changing pc, create a pipeline bubble so that the next stages are disabled and the instructions already inside the pipeline are not executed.</div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span>         else ce &lt;= 1;                                                  </div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span>     end</div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span> </div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span> </div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span> </div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span>    always @(posedge i_clk, negedge i_rst_n) begin</div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span>        if(!i_rst_n) begin</div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno">   78</span>            o_ce &lt;= 0;</div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span>            o_iaddr &lt;= PC_RESET;</div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span>            prev_pc &lt;= PC_RESET;</div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span>            stalled_inst &lt;= 0;</div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span>            o_pc &lt;= 0;</div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span>        end</div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span>        else begin </div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span>            if((ce &amp;&amp; !stall_bit) || (stall_bit &amp;&amp; !o_ce &amp;&amp; ce) || i_writeback_change_pc) begin // Update registers only if this stage is enabled and next stages are not stalled</div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span>                o_iaddr &lt;= iaddr_d;</div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span>                o_pc &lt;= stall_q? stalled_pc:prev_pc;</div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span>                o_inst &lt;= stall_q? stalled_inst:i_inst;</div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span>            end</div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span>            if(i_flush &amp;&amp; !stall_bit) begin // flush this stage(only when not stalled) so that clock-enable of next stage is disabled at next clock cycle</div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span>                o_ce &lt;= 0;</div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span>            end</div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span>            else if(!stall_bit) begin // clock-enable will change only when not stalled</div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span>                o_ce &lt;= ce_d;</div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span>            end</div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span> </div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span>            // If this stage is stalled but the next stage is not, disable the following stage&#39;s clock enablement at the next clock cycle (pipeline bubble).</div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span>            else if(stall_bit &amp;&amp; !i_stall) o_ce &lt;= 0; </div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span> </div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span> </div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span>            stall_q &lt;= i_stall || stall_fetch; // Raise stall when any of 5 stages is stalled</div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span> </div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span>            // Before stalling, save both the instruction and the PC so that we may return to these values when we need to exit the stall. </div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span>            if(stall_bit &amp;&amp; !stall_q) begin</div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span>                stalled_pc &lt;= prev_pc; </div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span>                stalled_inst &lt;= i_inst; </div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span>            end</div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span>            prev_pc &lt;= o_iaddr; // This is the first delay to align the PC to the pipeline</div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span>        end</div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span>    end</div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span>    // Logic for PC and pipeline clock_enable control</div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span>    always @* begin</div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span>        iaddr_d = 0;</div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span>        ce_d = 0;</div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span>        stall_fetch = i_stall; // When changing PC, stall when retrieving instructions, then do a pipeline bubble to disable the ce of the following stage.</div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span>        if(i_writeback_change_pc) begin</div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span>            iaddr_d = i_writeback_next_pc;</div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span>            ce_d = 0;</div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span>        end</div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span>        else if(i_alu_change_pc) begin</div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span>            iaddr_d  = i_alu_next_pc;</div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span>            ce_d = 0;</div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span>        end</div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span>        else begin</div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span>            iaddr_d = o_iaddr + 32&#39;d4;</div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno">  126</span>            ce_d = ce;</div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span>        end</div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span>    end</div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno">  129</span>    </div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span>endmodule</div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span> </div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span> </div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span> </div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span> </div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span> </div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span> </div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_35191fc563656ec8e3f935b60461952d.html">RISC-V-main</a></li><li class="navelem"><a class="el" href="dir_2820ad9171bf05546b333ebb8bc9bb96.html">rtl</a></li><li class="navelem"><a class="el" href="as__rv32i__fetch_8v.html">as_rv32i_fetch.v</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.7 </li>
  </ul>
</div>
</body>
</html>
